// prisma/schema.prisma

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// NOTE: We keep string-based "enums" (status/role/type fields) for portability.
// Validate allowed values in application code.
// For structured data (blocks, tags, sensations, meta) we store JSON strings
// in TEXT-like columns (String in Prisma).

// ------------------------
// Core User & Social Graph
// ------------------------

model User {
  id             String    @id @default(cuid())
  email          String    @unique
  password       String? // hashed password for email/password auth
  name           String?
  profileCode    String?   @unique // For user search
  emailVerified  DateTime?
  createdAt      DateTime  @default(now())
  lastSeen       DateTime? // Track last active time for online status
  // Follower/Following counts for real-time updates
  followersCount Int       @default(0)
  followingCount Int       @default(0)

  // Relations
  profile           Profile?
  posts             Post[]
  media             Media[]
  groupsOwned       Group[]             @relation("GroupsOwned")
  groupMembers      GroupMember[]
  friendshipsA      Friendship[]        @relation("A")
  friendshipsB      Friendship[]        @relation("B")
  happiness         HappinessScore[]
  userValues        UserValue[]
  bonds             BondBlueprint[]
  drills            ConflictDrill[]
  passkeys          PasskeyCredential[]
  serendipityLogs   SerendipityLog[]
  bondingActivities BondingActivity[]   @relation("BondingActivities")

  // New: metrics back-relation
  metrics Metric[]

  // New: journaling & templates
  journalEntries   JournalEntry[]
  journalTemplates JournalTemplate[]

  // Invites back-relation
  invitesSent Invite[]

  // --- Work management back-relations (added) ---
  orgsOwned       Organization[]      @relation("OrgOwner")
  orgMembership   OrgMember[]
  tasksCreated    Task[]              @relation("TaskCreator")
  taskAssignee    TaskAssignee[]
  checklistChecks TaskChecklistItem[] @relation("ChecklistCheckedBy")
  taskComments    TaskComment[]       @relation("TaskCommentAuthor")
  taskVolunteers  TaskVolunteer[]
  reminders       Reminder[]

  // --- Auth.js / NextAuth back-relations ---
  accounts     Account[]
  sessions     Session[]
  postLikes    PostLike[]
  postComments PostComment[]

  // --- Chat & Messaging ---
  conversationsA     Conversation[]              @relation("ConversationA")
  conversationsB     Conversation[]              @relation("ConversationB")
  messagesSent       Message[]                   @relation("MessagesSent")
  featureSessions    FeatureSession[]            @relation("FeatureSessions")
  featureParticipant FeatureSessionParticipant[] @relation("FeatureParticipants")
  chatSessions       ChatSessionLog[]            @relation("ChatSessions")
  chatAnalytics      ChatAnalytics?              @relation("Analytics")
  conversationStates ConversationState[]

  // --- Collaboration Features ---
  collaborationInvitesSent     CollaborationInvite[] @relation("CollaborationInvitesSent")
  collaborationInvitesReceived CollaborationInvite[] @relation("CollaborationInvitesReceived")
  collaborationUpdates         CollaborationUpdate[]

  // --- AI Chatbot ("dbot") ---
  userInsights   UserInsight[]
  aiChatSessions AIChatSession[]

  // --- Shop & E-commerce ---
  brandsOwned    Brand[]         @relation("BrandsOwned")
  productReviews ProductReview[] @relation("ProductReviews")
  brandReviews   BrandReview[]   @relation("BrandReviews")
  orders         Order[]         @relation("Orders")
  payments       Payment[] // Razorpay payments

  // --- User Marketplace ---
  profileCard  ProfileCard?
  productsSold Product[]     @relation("ProductsSold")
  productViews ProductView[] @relation("ProductViews")

  // --- Awe Routes & Places ---
  waypoints        RouteWaypoint[]
  waypointPhotos   WaypointPhoto[]   @relation("WaypointPhotoAuthor")
  photoShares      PhotoShare[]      @relation("PhotoShareRecipient")
  placeReviews     PlaceReview[]
  placePhotos      PlacePhoto[]      @relation("PlacePhotoAuthor")
  placePhotoShares PlacePhotoShare[] @relation("PlacePhotoShareRecipient")

  // --- Breathing App ---

  // --- Wrex (Gym Partners & Workout Plans) ---
  gymPartnersSent     GymPartner[]  @relation("GymPartnerSender")
  gymPartnersReceived GymPartner[]  @relation("GymPartnerReceiver")
  workoutPlans        WorkoutPlan[]
  // Workout Relations
  workouts        WorkoutSession[] @relation("UserWorkouts")
  partnerWorkouts WorkoutSession[] @relation("PartnerWorkouts")

  // --- Hopin Plans ---
  plansCreated    Plan[]           @relation("PlanCreator")
  planMemberships PlanMember[]
  moderationLogs  ModerationLog[]
  reportsMade     Report[]         @relation("Reporter")
  reactions       Reaction[]
  reactionBubbles ReactionBubble[]

  // Moderation
  isBanned  Boolean @default(false)
  banReason String?

  // Subscriptions (Bloom Mode)
  subscriptions Subscription[] @relation("Subscriber")
  subscribers   Subscription[] @relation("SubscribedTo")

  // Chapter Access Requests
  chapterAccessRequestsSent ChapterAccessRequest[]

  // PullUpDown Relations
  pullUpDownTags  PullUpDownOption[]
  pullUpDownVotes PullUpDownVote[]

  // Settings & Privacy
  // Settings & Privacy
  autoAcceptFollows     Boolean @default(false)
  defaultPostVisibility String  @default("PUBLIC") // PUBLIC | FOLLOWERS
  taggingPrivacy        String  @default("EVERYONE") // EVERYONE | FOLLOWERS

  // Notification Settings (JSON to control what notifications are received)
  // Structure: { likes: boolean, comments: boolean, mentions: boolean, follows: boolean, system: boolean }
  notificationSettings Json?

  // Activity & History
  viewHistory ViewHistory[]
  postTags    PostTag[]

  // Hidden & Muted
  hiddenPosts      HiddenPost[]
  mutedUsers       MutedUser[]       @relation("Muter")
  mutedBy          MutedUser[]       @relation("MutedUser")
  stressMapEntries StressMapEntry[]
  healthConditions HealthCondition[]
  dietPlans        DietPlan[]
  biometricLogs    BiometricLog[]
  nutritionLogs    NutritionLog[]
  savedFoods       SavedFood[]
  todos            Todo[]
}

model Todo {
  id        String   @id @default(cuid())
  userId    String
  title     String
  status    String   @default("PENDING") // PENDING, COMPLETED
  priority  String   @default("MEDIUM")
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
}

model HiddenPost {
  id        String   @id @default(cuid())
  userId    String
  postId    String
  createdAt DateTime @default(now())

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)
  post Post @relation(fields: [postId], references: [id], onDelete: Cascade)

  @@unique([userId, postId])
  @@index([userId])
}

model MutedUser {
  id          String   @id @default(cuid())
  muterId     String
  mutedUserId String
  // JSON array of strings: ["ALL"] or ["STORY", "POST", etc]
  mutedTypes  String   @default("[\"ALL\"]")
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  muter     User @relation("Muter", fields: [muterId], references: [id], onDelete: Cascade)
  mutedUser User @relation("MutedUser", fields: [mutedUserId], references: [id], onDelete: Cascade)

  @@unique([muterId, mutedUserId])
  @@index([muterId])
}

model Subscription {
  id             String   @id @default(cuid())
  subscriberId   String
  subscribedToId String
  createdAt      DateTime @default(now())

  subscriber   User @relation("Subscriber", fields: [subscriberId], references: [id], onDelete: Cascade)
  subscribedTo User @relation("SubscribedTo", fields: [subscribedToId], references: [id], onDelete: Cascade)

  @@unique([subscriberId, subscribedToId])
  @@index([subscriberId])
  @@index([subscribedToId])
}

model Plan {
  id          String   @id @default(cuid())
  title       String
  description String?
  creatorId   String
  
  // New Fields
  type          String   @default("SOLO") // SOLO | COMMUNITY
  location      String?  // Text description or JSON coordinates
  locationLink  String?  // Google Maps link
  isLocationLocked Boolean @default(false)
  
  latitude      Float?
  longitude     Float?
  visibility    String   @default("PRIVATE") // PRIVATE | FOLLOWERS | PUBLIC
  
  date          DateTime?
  maxSize       Int?     
  mediaUrls     String?  // JSON array of image/video URLs
  slashes       String?  // JSON array of tags (e.g. #nightout)
  status        String   @default("OPEN") // OPEN | FULL | COMPLETED | CANCELLED
  
  posts         Post[]   @relation("CommunityPosts") // Community posts for the plan

  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  creator User         @relation("PlanCreator", fields: [creatorId], references: [id], onDelete: Cascade)
  members PlanMember[]
  workouts WorkoutSession[] @relation("PlanWorkouts")


  @@index([creatorId])
  @@index([date])
}

model PlanMember {
  id        String   @id @default(cuid())
  planId    String
  userId    String
  status    String   @default("PENDING") // PENDING, ACCEPTED, REJECTED, INTERESTED
  
  // Verification
  verificationCode String? // 7-digit code generated on ACCEPTED
  qrCodeUrl        String? // URL to QR code image (or generated on client)
  isVerified       Boolean @default(false)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  plan Plan @relation(fields: [planId], references: [id], onDelete: Cascade)
  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([planId, userId])
  @@index([planId])
  @@index([userId])
}

model GymPartner {
  id        String   @id @default(cuid())
  userId    String // The sender
  partnerId String // The receiver
  status    String   @default("PENDING") // PENDING | ACCEPTED | REJECTED
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  user    User @relation("GymPartnerSender", fields: [userId], references: [id], onDelete: Cascade)
  partner User @relation("GymPartnerReceiver", fields: [partnerId], references: [id], onDelete: Cascade)

  @@unique([userId, partnerId])
  @@index([userId])
  @@index([partnerId])
}

model WorkoutPlan {
  id          String   @id @default(cuid())
  userId      String
  name        String
  description String?
  frequency   String   @default("3x")
  duration    Int      @default(12) // Weeks
  exercises   String // JSON string of Exercise[]
  schedule    String? // JSON string of schedule mapping
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
}

model Profile {
  userId        String  @id
  displayName   String?
  avatarUrl     String?
  bio           String?
  location      String?
  tags          String?
  coverVideoUrl String?
  coverImageUrl String?
  isPrivate     Boolean @default(false)

  // -- Basics --
  dob                 DateTime? // <--- Replaced 'age'
  gender              String?   // User's gender
  height              String? // e.g. "5'10" or "178cm"
  weight              String? // e.g. "70kg"
  city                String?
  isOpenToWorkout     Boolean @default(false) // Toggle for Gym Pal suggestions
  interactionMode     String?
  conversationStarter String?

  // -- Professional & Skills --
  achievements String?
  skills       String[] // JSON array of strings
  workHistory  String?
  education    String?

  // -- Vibe --
  bestVibeTime   String?
  vibeWithPeople String?
  lifeIsLike     String? // "With me life is like..."

  // -- Deep Dive --
  values          String[] // e.g., Growth, Money, Spiritual
  hardNos         String[] // e.g., Smoking, Political talks
  emotionalFit    String? // "Only people who can emotionally fit..."
  pleaseDont      String? // "Please don't with me..."
  careAbout       String? // "What I care about..."
  protectiveAbout String? // "One thing I'm protective about..."
  distanceMakers  String? // "The distance makers..."

  // -- Favorites & Interests --
  topMovies         String[]
  topGenres         String[]
  topSongs          String[]
  topFoods          String[]
  topPlaces         String[]
  topGames          String[]
  currentlyInto     String[]
  dislikes          String[]
  icks              String[]
  goals             String?
  lifestyle         String?
  interactionTopics String[]
  shoppingInterests String[] // User's shopping preferences (slashes)

  // -- Media --
  stalkMe String? // JSON string: [{url, type}, ...] (11 items)

  // -- Profile Card Customization --
  cardBackgroundUrl String?
  cardSettings      String? // JSON string for visibility: { showDob: true, showSkills: false ... }

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)
}

model Group {
  id          String   @id @default(cuid())
  name        String
  description String?
  ownerId     String
  createdAt   DateTime @default(now())

  owner   User          @relation("GroupsOwned", fields: [ownerId], references: [id], onDelete: Cascade)
  members GroupMember[]
  posts   Post[]
}

model GroupMember {
  id        String   @id @default(cuid())
  userId    String
  groupId   String
  // Allowed: OWNER | ADMIN | MEMBER
  role      String   @default("MEMBER")
  createdAt DateTime @default(now())

  user  User  @relation(fields: [userId], references: [id], onDelete: Cascade)
  group Group @relation(fields: [groupId], references: [id], onDelete: Cascade)

  @@unique([userId, groupId])
}

model Friendship {
  id        String   @id @default(cuid())
  userId    String
  friendId  String
  // Allowed: PENDING | ACCEPTED | BLOCKED | GHOSTED
  status    String   @default("PENDING")
  // Track if request was ghosted by the recipient
  isGhosted Boolean  @default(false)
  // ID of user who ghosted (the recipient if ghosted)
  ghostedBy String?
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  user   User @relation("A", fields: [userId], references: [id], onDelete: Cascade)
  friend User @relation("B", fields: [friendId], references: [id], onDelete: Cascade)

  @@unique([userId, friendId])
}

model Post {
  id                  String    @id @default(cuid())
  userId              String
  groupId             String?
  planId              String?
  // Allowed: JOURNAL | JOY | AWE | BONDS | SERENDIPITY | CHECKIN | PROGRESS | OTHER
  feature             String    @default("OTHER")
  // NEW: Post type - STANDARD | CHAPTER | XRAY | LILL | FILL | AUD | CHAN | PULLUPDOWN
  postType            String    @default("STANDARD")
  content             String
  // Allowed: PUBLIC | FRIENDS | PRIVATE | SPECIFIC
  visibility          String    @default("PUBLIC")
  // Expiration for Timed Posts
  expiresAt           DateTime?
  joyScore            Int       @default(0)
  connectionScore     Int       @default(0)
  creativityScore     Int       @default(0)
  // Chapter Access Policy
  chapterAccessPolicy String    @default("PUBLIC") // PUBLIC | PRIVATE | OWNER_ONLY
  // Moderation
  moderationStatus    String    @default("CLEAN") // CLEAN, FLAGGED, REMOVED
  moderationReason    String?
  status              String    @default("PUBLISHED") // PUBLISHED, DRAFT, ARCHIVED
  createdAt           DateTime  @default(now())
  updatedAt           DateTime  @updatedAt

  user     User          @relation(fields: [userId], references: [id], onDelete: Cascade)
  group    Group?        @relation(fields: [groupId], references: [id], onDelete: SetNull)
  plan     Plan?         @relation("CommunityPosts", fields: [planId], references: [id], onDelete: SetNull)
  media    Media[]
  likes    PostLike[]
  comments PostComment[]

  shares PostShare[]

  reports Report[]

  reactions       Reaction[]
  reactionBubbles ReactionBubble[]

  // Collaboration
  chapterAccessRequests ChapterAccessRequest[]

  // Relations to new post types
  chapterData Chapter?
  xrayData    Xray?
  storyData   Story?

  simpleData     SimplePost?
  lillData       Lill?
  fillData       Fill?
  audData        Aud?
  chanData       Chan?
  pullUpDownData PullUpDown?

  // Activity & History
  viewHistory ViewHistory[]
  postTags    PostTag[]
  hiddenPosts HiddenPost[]

  // New Slashes Relation
  slashes     Slash[]

  // Metrics
  impressions Int @default(0)
  shareCount  Int @default(0)
  viewCount   Int @default(0)

  @@index([postType])
  @@index([createdAt])
  @@index([planId])
}

// Slashes (Hashtags)
model Slash {
  id        String   @id @default(cuid())
  tag       String   @unique
  createdAt DateTime @default(now())
  
  posts     Post[]

  @@index([tag])
}

model PostLike {
  id        String   @id @default(cuid())
  userId    String
  postId    String
  createdAt DateTime @default(now())

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)
  post Post @relation(fields: [postId], references: [id], onDelete: Cascade)

  @@unique([userId, postId])
  @@index([postId])
  @@index([userId])
}

model PostComment {
  id        String   @id @default(cuid())
  userId    String
  postId    String
  content   String
  createdAt DateTime @default(now())

  post Post @relation(fields: [postId], references: [id], onDelete: Cascade)
  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([postId])
  @@index([userId])
}

model PostShare {
  id        String   @id @default(cuid())
  userId    String
  postId    String
  toUserId  String?
  toGroupId String?
  message   String?
  createdAt DateTime @default(now())

  post Post @relation(fields: [postId], references: [id], onDelete: Cascade)

  @@index([postId])
  @@index([userId])
  @@index([toUserId])
  @@index([toGroupId])
}

model Notification {
  id        String   @id @default(cuid())
  userId    String
  type      String
  message   String
  postId    String?
  read      Boolean  @default(false)
  createdAt DateTime @default(now())

  @@index([userId, read])
  @@index([createdAt])
}

model Report {
  id         String   @id @default(cuid())
  postId     String?
  reporterId String
  reason     String
  // PENDING | RESOLVED | DISMISSED
  status     String   @default("PENDING")
  details    String?
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt

  post     Post? @relation(fields: [postId], references: [id], onDelete: Cascade)
  reporter User  @relation("Reporter", fields: [reporterId], references: [id], onDelete: Cascade)

  // New Fields
  target         String  @default("FUY") // FUY | SELLER
  productId      String?
  orderId        String?
  conversationId String?
  adminNotes     String?

  product      Product?      @relation(fields: [productId], references: [id], onDelete: SetNull)
  order        Order?        @relation(fields: [orderId], references: [id], onDelete: SetNull)
  conversation Conversation? @relation(fields: [conversationId], references: [id], onDelete: SetNull)

  @@index([postId])
  @@index([reporterId])
  @@index([status])
  @@index([target])
  @@index([productId])
}

model Reaction {
  id        String   @id @default(cuid())
  userId    String
  postId    String
  // W | L | CAP | FIRE
  type      String
  createdAt DateTime @default(now())

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)
  post Post @relation(fields: [postId], references: [id], onDelete: Cascade)

  @@unique([userId, postId])
  @@index([postId])
}

model ReactionBubble {
  id        String   @id @default(cuid())
  userId    String
  postId    String
  mediaUrl  String
  // IMAGE | VIDEO
  mediaType String   @default("VIDEO")
  createdAt DateTime @default(now())

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)
  post Post @relation(fields: [postId], references: [id], onDelete: Cascade)

  @@index([postId])
  @@index([createdAt])
}

model Media {
  id        String   @id @default(cuid())
  postId    String
  userId    String
  // Mirrors post feature: JOURNAL | JOY | ...
  feature   String   @default("OTHER")
  // Allowed: IMAGE | VIDEO | AUDIO
  type      String
  url       String
  createdAt DateTime @default(now())

  post Post @relation(fields: [postId], references: [id], onDelete: Cascade)
  user User @relation(fields: [userId], references: [id], onDelete: Cascade)
}

// ========================
// Advanced Post Types
// ========================

// Chapters - Multi-media collections with linking
model Chapter {
  id              String   @id @default(cuid())
  postId          String   @unique
  title           String?
  description     String?
  linkedChapterId String? // Link to previous chapter
  linkedPostId    String? // Link to any previous post
  mediaUrls       String // JSON array of media URLs
  mediaTypes      String // JSON array of media types (image/video/audio/text)
  orderIndex      Int      @default(0)
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  post          Post      @relation(fields: [postId], references: [id], onDelete: Cascade)
  linkedChapter Chapter?  @relation("ChapterLinks", fields: [linkedChapterId], references: [id], onDelete: SetNull)
  nextChapters  Chapter[] @relation("ChapterLinks")

  @@index([postId])
  @@index([linkedChapterId])
  @@index([createdAt])
}

model ChapterAccessRequest {
  id           String   @id @default(cuid())
  requesterId  String
  targetPostId String
  status       String   @default("PENDING") // PENDING, ACCEPTED, REJECTED
  createdAt    DateTime @default(now())

  requester  User @relation(fields: [requesterId], references: [id], onDelete: Cascade)
  targetPost Post @relation(fields: [targetPostId], references: [id], onDelete: Cascade)

  @@unique([requesterId, targetPostId])
  @@index([requesterId])
  @@index([targetPostId])
}

// Xrays - 2-layer interactive scratch posts
model Xray {
  id              String   @id @default(cuid())
  postId          String   @unique
  topLayerUrl     String // Image/video URL for top layer
  topLayerType    String // IMAGE | VIDEO
  bottomLayerUrl  String // Image/video URL revealed on scratch
  bottomLayerType String // IMAGE | VIDEO
  scratchPattern  String   @default("RANDOM") // RANDOM | GRID | CUSTOM
  revealPercent   Int      @default(0) // Percentage revealed (for analytics)
  createdAt       DateTime @default(now())

  post Post @relation(fields: [postId], references: [id], onDelete: Cascade)

  @@index([postId])
}

// Simple Post - Instagram style (up to 8 media items)
model SimplePost {
  id         String   @id @default(cuid())
  postId     String   @unique
  mediaUrls  String // JSON array of strings
  mediaTypes String // JSON array of 'IMAGE' | 'VIDEO'
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt

  post Post @relation(fields: [postId], references: [id], onDelete: Cascade)

  @@index([postId])
}

// Stories - Timed content
model Story {
  id        String   @id @default(cuid())
  postId    String   @unique
  duration  Int // Duration in hours (1-48)
  createdAt DateTime @default(now())

  post Post @relation(fields: [postId], references: [id], onDelete: Cascade)

  @@index([postId])
  @@index([createdAt]) // For querying active stories
}

// Lills - Short-form videos (like reels)
model Lill {
  id           String   @id @default(cuid())
  postId       String   @unique
  videoUrl     String
  thumbnailUrl String?
  duration     Int // Duration in seconds (max 60)
  aspectRatio  String   @default("9:16") // Vertical video
  musicUrl     String? // Optional background music
  musicTitle   String?
  filters      String? // JSON array of applied filters
  createdAt    DateTime @default(now())

  post Post @relation(fields: [postId], references: [id], onDelete: Cascade)

  @@index([postId])
  @@index([createdAt])
}

// Fills - Long-form videos (YouTube-style)
model Fill {
  id           String   @id @default(cuid())
  postId       String   @unique
  videoUrl     String
  thumbnailUrl String?
  duration     Int // Duration in seconds
  aspectRatio  String   @default("16:9") // Horizontal video
  chapters     String? // JSON array of {time, title} for video chapters
  subtitlesUrl String? // Optional subtitles file
  quality      String   @default("HD") // SD | HD | FHD | 4K
  createdAt    DateTime @default(now())

  post Post @relation(fields: [postId], references: [id], onDelete: Cascade)

  @@index([postId])
  @@index([createdAt])
}

// Auds - Audio files
model Aud {
  id            String   @id @default(cuid())
  postId        String   @unique
  audioUrl      String
  duration      Int // Duration in seconds
  waveformData  String? // JSON array of amplitude values for visualization
  coverImageUrl String? // Optional cover art
  artist        String?
  title         String?
  genre         String?
  createdAt     DateTime @default(now())

  post Post @relation(fields: [postId], references: [id], onDelete: Cascade)

  @@index([postId])
  @@index([createdAt])
}

// Chans - Channels with episodes/scheduled content
model Chan {
  id              String   @id @default(cuid())
  postId          String   @unique
  channelName     String
  description     String?
  coverImageUrl   String?
  schedule        String? // JSON array of {day, time, title} - DEPRECATED
  isLive          Boolean  @default(false)
  liveUrl         String? // URL for live stream if active
  episodes        String? // JSON array of {title, url, thumbnail, duration} - DEPRECATED
  subscriberCount Int      @default(0)
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  post Post @relation(fields: [postId], references: [id], onDelete: Cascade)

  shows Show[]

  @@index([postId])
  @@index([isLive])
  @@index([createdAt])
}

model Show {
  id          String   @id @default(cuid())
  chanId      String
  title       String
  description String?
  coverUrl    String?
  schedule    String? // e.g. "Mon 9 PM IST" or JSON
  credits     String? // JSON array of cast/crew
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  isArchived  Boolean  @default(false)

  chan     Chan      @relation(fields: [chanId], references: [id], onDelete: Cascade)
  episodes Episode[]

  @@index([chanId])
}

model Episode {
  id            String    @id @default(cuid())
  showId        String
  title         String
  description   String?
  episodeNumber Int
  coverUrl      String?
  trailerUrl    String?
  videoUrl      String?
  duration      Int       @default(0) // seconds
  releaseDate   DateTime?
  credits       String? // JSON array of cast/crew
  isLive        Boolean   @default(false)
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt

  show Show @relation(fields: [showId], references: [id], onDelete: Cascade)

  @@index([showId])
}

// PullUpDown - Voting/polling posts
model PullUpDown {
  id       String @id @default(cuid())
  postId   String @unique
  question String

  // Options are now a separate relation
  options PullUpDownOption[]

  allowMultiple Boolean   @default(false)
  expiresAt     DateTime?
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt

  post  Post             @relation(fields: [postId], references: [id], onDelete: Cascade)
  votes PullUpDownVote[]

  @@index([postId])
  @@index([expiresAt])
}

model PullUpDownOption {
  id             String  @id @default(cuid())
  pullUpDownId   String
  text           String
  specialDetails String?
  uniqueDetails  String?

  // User tagging for this option
  taggedUserId String?
  tagStatus    String  @default("PENDING") // PENDING, ACCEPTED, REJECTED

  voteCount Int @default(0)

  pullUpDown PullUpDown       @relation(fields: [pullUpDownId], references: [id], onDelete: Cascade)
  taggedUser User?            @relation(fields: [taggedUserId], references: [id], onDelete: SetNull)
  votes      PullUpDownVote[]

  @@index([pullUpDownId])
  @@index([taggedUserId])
}

// Track individual votes for PullUpDown
model PullUpDownVote {
  id           String   @id @default(cuid())
  pullUpDownId String
  userId       String
  optionId     String // Link to specific option
  createdAt    DateTime @default(now())

  pullUpDown PullUpDown       @relation(fields: [pullUpDownId], references: [id], onDelete: Cascade)
  option     PullUpDownOption @relation(fields: [optionId], references: [id], onDelete: Cascade)
  user       User             @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([pullUpDownId, userId])
  @@index([pullUpDownId])
  @@index([userId])
  @@index([optionId])
}

model HappinessScore {
  id        String   @id @default(cuid())
  userId    String
  // Allowed: JOY | CONNECTION | CREATIVITY
  category  String
  value     Int
  // Source feature: JOURNAL | JOY | AWE | BONDS | SERENDIPITY | CHECKIN | PROGRESS | OTHER
  source    String   @default("OTHER")
  createdAt DateTime @default(now())

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)
}

model Value {
  id    String @id @default(cuid())
  slug  String @unique
  label String

  userValues UserValue[]
}

model UserValue {
  id      String @id @default(cuid())
  userId  String
  valueId String
  rank    Int

  user  User  @relation(fields: [userId], references: [id], onDelete: Cascade)
  value Value @relation(fields: [valueId], references: [id], onDelete: Cascade)

  @@unique([userId, valueId])
}

model BondBlueprint {
  id         String   @id @default(cuid())
  userId     String
  personName String
  goal       String?
  notes      String?
  createdAt  DateTime @default(now())

  user   User            @relation(fields: [userId], references: [id], onDelete: Cascade)
  drills ConflictDrill[]
}

model ConflictDrill {
  id          String    @id @default(cuid())
  userId      String
  blueprintId String?
  notes       String?
  resolvedAt  DateTime?
  createdAt   DateTime  @default(now())

  user      User           @relation(fields: [userId], references: [id], onDelete: Cascade)
  blueprint BondBlueprint? @relation(fields: [blueprintId], references: [id], onDelete: SetNull)
}

model PasskeyCredential {
  id                  String  @id @default(cuid())
  userId              String
  credentialID        String  @unique // base64url
  credentialPublicKey String // base64url
  counter             Int     @default(0)
  transports          String? // comma-separated list
  aaguid              String? // optional

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
}

model SerendipityLog {
  id        String   @id @default(cuid())
  userId    String
  weekNum   Int
  year      Int
  packId    String?
  completed Boolean  @default(false)
  notes     String?
  createdAt DateTime @default(now())

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId, weekNum, year])
}

// New: Generic metrics table for stats from any feature (e.g., stress_avg_intensity, calm_index).
// Stores a numeric value plus optional category. User is optional to allow anonymous.
model Metric {
  id        String   @id @default(cuid())
  userId    String?
  type      String
  category  String?
  value     Float
  createdAt DateTime @default(now())

  user User? @relation(fields: [userId], references: [id], onDelete: SetNull)

  @@index([type, createdAt])
  @@index([userId, type, createdAt])
}

// ------------------------
// Journaling (Canvas + Templates)
// ------------------------

model JournalEntry {
  id               String    @id @default(cuid())
  userId           String
  content          String
  blocks           String? // JSON string: [{ id, type: "TEXT" | "IMAGE" | "VIDEO" | "AUDIO", ... }]
  // Optional extras used by your UI (all optional to keep flexible)
  mood             Int?
  moodColor        String?
  tags             String? // JSON string: ["gratitude","walk"]
  sensations       String? // JSON string: [{ zone: "Chest", note: "tight" }]
  meta             String? // JSON string: template blocks used, persona, etc.
  unlockAt         DateTime?
  shadowPassphrase String? // store hashed in API if sensitive
  visibility       String    @default("PRIVATE") // if you ever expose journals themselves

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId, createdAt])
  @@index([visibility, createdAt])
}

// Reusable canvas templates users can publish or keep private.
// Blocks are stored as JSON string in TEXT; owner is required.
model JournalTemplate {
  id          String  @id @default(cuid())
  userId      String
  name        String
  description String?
  visibility  String  @default("PRIVATE") // PUBLIC | PRIVATE
  blocks      String // JSON string
  author      String?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId, createdAt])
  @@index([visibility, createdAt])
}

// ------------------------
// Invites (added)
// ------------------------

model Invite {
  id         String    @id @default(cuid())
  token      String    @unique
  email      String?
  username   String?
  inviterId  String
  status     String    @default("PENDING") // PENDING | ACCEPTED | REVOKED | EXPIRED
  createdAt  DateTime  @default(now())
  expiresAt  DateTime
  acceptedAt DateTime?
  revokedAt  DateTime?

  inviter User @relation(fields: [inviterId], references: [id], onDelete: Cascade)

  @@index([inviterId])
  @@index([status, expiresAt])
}

// ------------------------
// Work Management (Organizations / Projects / Tasks)
// ------------------------

model Organization {
  id          String   @id @default(cuid())
  name        String
  description String?
  ownerId     String
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  owner    User        @relation("OrgOwner", fields: [ownerId], references: [id], onDelete: Cascade)
  members  OrgMember[]
  projects Project[]
  tags     Tag[]
}

model OrgMember {
  id             String   @id @default(cuid())
  organizationId String
  userId         String
  role           String   @default("MEMBER") // ADMIN | MANAGER | MEMBER
  createdAt      DateTime @default(now())

  organization Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  user         User         @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([organizationId, userId])
  @@index([organizationId])
  @@index([userId])
}

model Project {
  id             String    @id @default(cuid())
  organizationId String
  name           String
  description    String?
  status         String    @default("ACTIVE") // ACTIVE | ARCHIVED
  startDate      DateTime?
  dueDate        DateTime?
  createdAt      DateTime  @default(now())
  updatedAt      DateTime  @updatedAt

  organization Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  tasks        Task[]

  @@index([organizationId])
  @@index([status])
  @@index([dueDate])
}

model Task {
  id              String    @id @default(cuid())
  projectId       String
  title           String
  description     String?
  status          String    @default("TODO") // TODO | IN_PROGRESS | REVIEW | DONE
  priority        String    @default("MEDIUM") // LOW | MEDIUM | HIGH | URGENT
  startDate       DateTime?
  dueDate         DateTime?
  createdById     String
  timeEstimateMin Int?
  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt

  project   Project @relation(fields: [projectId], references: [id], onDelete: Cascade)
  createdBy User    @relation("TaskCreator", fields: [createdById], references: [id], onDelete: Cascade)

  assignees  TaskAssignee[]
  checklist  TaskChecklistItem[]
  comments   TaskComment[]
  tags       TaskTag[]
  reminders  Reminder[]
  volunteers TaskVolunteer[]

  @@index([projectId])
  @@index([status])
  @@index([dueDate])
}

model TaskAssignee {
  id         String   @id @default(cuid())
  taskId     String
  userId     String
  assignedAt DateTime @default(now())

  task Task @relation(fields: [taskId], references: [id], onDelete: Cascade)
  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([taskId, userId])
  @@index([userId])
}

model TaskChecklistItem {
  id          String    @id @default(cuid())
  taskId      String
  label       String
  completed   Boolean   @default(false)
  checkedById String?
  checkedAt   DateTime?

  task      Task  @relation(fields: [taskId], references: [id], onDelete: Cascade)
  checkedBy User? @relation("ChecklistCheckedBy", fields: [checkedById], references: [id], onDelete: SetNull)

  @@index([taskId])
  @@index([checkedById])
}

model TaskComment {
  id        String   @id @default(cuid())
  taskId    String
  authorId  String
  body      String
  createdAt DateTime @default(now())

  task   Task @relation(fields: [taskId], references: [id], onDelete: Cascade)
  author User @relation("TaskCommentAuthor", fields: [authorId], references: [id], onDelete: Cascade)

  @@index([taskId])
  @@index([authorId])
}

model Tag {
  id             String   @id @default(cuid())
  organizationId String
  name           String
  colorHex       String?
  createdAt      DateTime @default(now())

  organization Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  taskTags     TaskTag[]

  @@unique([organizationId, name])
  @@index([organizationId])
}

model TaskTag {
  id     String @id @default(cuid())
  taskId String
  tagId  String

  task Task @relation(fields: [taskId], references: [id], onDelete: Cascade)
  tag  Tag  @relation(fields: [tagId], references: [id], onDelete: Cascade)

  @@unique([taskId, tagId])
  @@index([tagId])
}

model TaskVolunteer {
  id        String   @id @default(cuid())
  taskId    String
  userId    String
  status    String   @default("REQUESTED") // REQUESTED | APPROVED | DECLINED
  createdAt DateTime @default(now())

  task Task @relation(fields: [taskId], references: [id], onDelete: Cascade)
  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([taskId, userId])
  @@index([userId])
}

model Reminder {
  id        String   @id @default(cuid())
  taskId    String
  userId    String
  triggerAt DateTime
  type      String   @default("DUE") // DUE | START | CUSTOM
  sent      Boolean  @default(false)
  createdAt DateTime @default(now())

  task Task @relation(fields: [taskId], references: [id], onDelete: Cascade)
  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([triggerAt, sent])
  @@index([userId])
}

// ------------------------
// Chat & Messaging System
// ------------------------

model Conversation {
  id            String    @id @default(cuid())
  participantA  String // userId of participant A
  participantB  String // userId of participant B
  lastMessage   String?
  lastMessageAt DateTime?
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt

  userA                User                  @relation("ConversationA", fields: [participantA], references: [id], onDelete: Cascade)
  userB                User                  @relation("ConversationB", fields: [participantB], references: [id], onDelete: Cascade)
  messages             Message[]
  sessionLogs          ChatSessionLog[]
  collaborationInvites CollaborationInvite[]
  reports              Report[]

  states ConversationState[]

  @@unique([participantA, participantB])
  @@index([participantA])
  @@index([participantB])
  @@index([lastMessageAt])
}

model ConversationState {
  id             String    @id @default(cuid())
  conversationId String
  userId         String
  isDeleted      Boolean   @default(false)
  isMuted        Boolean   @default(false)
  lastDeletedAt  DateTime? // To hide messages before this date if "deleted"
  createdAt      DateTime  @default(now())
  updatedAt      DateTime  @updatedAt

  conversation Conversation @relation(fields: [conversationId], references: [id], onDelete: Cascade)
  user         User         @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([conversationId, userId])
  @@index([userId])
  @@index([conversationId])
}

model Message {
  id             String    @id @default(cuid())
  conversationId String
  senderId       String
  content        String
  type           String    @default("text") // text, image, video, audio
  mediaUrl       String?
  readAt         DateTime?
  createdAt      DateTime  @default(now())

  conversation Conversation @relation(fields: [conversationId], references: [id], onDelete: Cascade)
  sender       User         @relation("MessagesSent", fields: [senderId], references: [id], onDelete: Cascade)
  tags         String[]  @default([])

  @@index([conversationId])
  @@index([senderId])
  @@index([createdAt])
}

model ChatSessionLog {
  id              String    @id @default(cuid())
  conversationId  String
  userId          String
  startTime       DateTime  @default(now())
  endTime         DateTime?
  durationMinutes Int? // Calculated duration

  conversation Conversation @relation(fields: [conversationId], references: [id], onDelete: Cascade)
  user         User         @relation("ChatSessions", fields: [userId], references: [id], onDelete: Cascade)

  @@index([conversationId])
  @@index([userId])
  @@index([startTime])
}

model ChatAnalytics {
  id                    String   @id @default(cuid())
  userId                String
  totalMessagesCount    Int      @default(0)
  totalChatTimeMinutes  Int      @default(0)
  mostFrequentContactId String?
  lastAnalyzedAt        DateTime @default(now())
  updatedAt             DateTime @updatedAt

  user User @relation("Analytics", fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId])
  @@index([userId])
}

// Feature Collaboration: Track collaborative sessions
model FeatureSession {
  id             String   @id @default(cuid())
  type           String // "JOURNALING" | "HOPPING" | "BONDING" | "BREATHING"
  creatorId      String
  conversationId String? // Link to chat for planning
  title          String?
  description    String?
  status         String   @default("ACTIVE") // ACTIVE | ARCHIVED
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt

  // Collaboration features
  canvasData      String? // JSON: blocks, drawing state
  
  // Hopin / Plan fields
  latitude        Float?
  longitude       Float?
  location        String?
  visibility      String   @default("PRIVATE") // PRIVATE | FOLLOWERS | PUBLIC
  tags            String?  // JSON array of strings
  
  autoSaveEnabled Boolean   @default(true)
  lastSavedAt     DateTime?
  lastModifiedBy  String?
  syncVersion     Int       @default(0)

  creator      User                        @relation("FeatureSessions", fields: [creatorId], references: [id], onDelete: Cascade)
  participants FeatureSessionParticipant[]
  invites      CollaborationInvite[]
  updates      CollaborationUpdate[]

  @@index([creatorId])
  @@index([type])
  @@index([status])
  @@index([lastModifiedBy])
  @@index([updatedAt])
}

model FeatureSessionParticipant {
  id        String   @id @default(cuid())
  sessionId String
  userId    String
  joinedAt  DateTime @default(now())
  status    String   @default("ACTIVE") // ACTIVE | LEFT | INVITED

  session FeatureSession @relation(fields: [sessionId], references: [id], onDelete: Cascade)
  user    User           @relation("FeatureParticipants", fields: [userId], references: [id], onDelete: Cascade)

  @@unique([sessionId, userId])
  @@index([sessionId])
  @@index([userId])
}

// Collaboration Invites - for messaging system
model CollaborationInvite {
  id             String    @id @default(cuid())
  sessionId      String
  fromUserId     String
  toUserId       String
  featureType    String // CANVAS | HOPIN | BREATHING | etc.
  status         String    @default("PENDING") // PENDING | ACCEPTED | REJECTED | CANCELLED
  messageId      String?
  conversationId String
  createdAt      DateTime  @default(now())
  respondedAt    DateTime?

  session      FeatureSession @relation(fields: [sessionId], references: [id], onDelete: Cascade)
  fromUser     User           @relation("CollaborationInvitesSent", fields: [fromUserId], references: [id], onDelete: Cascade)
  toUser       User           @relation("CollaborationInvitesReceived", fields: [toUserId], references: [id], onDelete: Cascade)
  conversation Conversation   @relation(fields: [conversationId], references: [id], onDelete: Cascade)

  @@unique([sessionId, fromUserId, toUserId])
  @@index([sessionId])
  @@index([fromUserId])
}

// Collaboration Updates - for tracking changes in real-time
model CollaborationUpdate {
  id        String   @id @default(cuid())
  sessionId String
  userId    String
  operation String // ADD_BLOCK | UPDATE_BLOCK | REMOVE_BLOCK | DRAW | SAVE
  blockId   String?
  data      String // JSON
  synced    Boolean  @default(false)
  createdAt DateTime @default(now())

  session FeatureSession @relation(fields: [sessionId], references: [id], onDelete: Cascade)
  user    User           @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([sessionId])
  @@index([userId])
}



// ------------------------
// Wrex (Grounding) Features
// ------------------------

model StressMapEntry {
  id        String   @id @default(cuid())
  userId    String
  side      String // FRONT | BACK
  region    String
  x         Float
  y         Float
  z         Float?    @default(0)
  intensity Int
  quality   String
  note      String?
  createdAt DateTime @default(now())

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([createdAt])
}



model WorkoutSession {
  id          String   @id @default(cuid())
  userId      String
  name        String
  date        DateTime @default(now())
  completed   Boolean  @default(false)
  exercises   WorkoutExercise[] 
  partnerId   String?
  planId      String?
  calories    Int?     @default(0)

  user    User      @relation("UserWorkouts", fields: [userId], references: [id], onDelete: Cascade)
  partner User?     @relation("PartnerWorkouts", fields: [partnerId], references: [id], onDelete: SetNull)
  plan    Plan?     @relation("PlanWorkouts", fields: [planId], references: [id], onDelete: SetNull)

  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@index([userId])
  @@index([date])
}

model WorkoutExercise {
  id        String   @id @default(cuid())
  sessionId String
  name      String
  order     Int      @default(0)
  sets      WorkoutSet[]
  
  session   WorkoutSession @relation(fields: [sessionId], references: [id], onDelete: Cascade)

  @@index([sessionId])
}

model WorkoutSet {
  id         String   @id @default(cuid())
  exerciseId String
  
  reps       Int
  weight     Float?
  restSeconds Int     @default(60)

  // Status for each user (if partner workout)
  completed  Boolean  @default(false)
  completedByPartner Boolean @default(false)

  exercise   WorkoutExercise @relation(fields: [exerciseId], references: [id], onDelete: Cascade)

  @@index([exerciseId])
}

model HealthCondition {
  id       String   @id @default(cuid())
  userId   String
  type     String // INJURY | ILLNESS | ALLERGY | MEDICATION
  name     String
  date     DateTime
  notes    String?
  resolved Boolean  @default(false)

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
}

model DietPlan {
  id          String   @id @default(cuid())
  userId      String
  name        String
  description String?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  items DietItem[]
  user  User       @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
}

model DietItem {
  id         String @id @default(cuid())
  dietPlanId String
  foodName   String
  quantity   Float
  unit       String
  calories   Float
  protein    Float
  carbs      Float
  fats       Float

  dietPlan DietPlan @relation(fields: [dietPlanId], references: [id], onDelete: Cascade)

  @@index([dietPlanId])
}

// ------------------------
// Auth.js / NextAuth tables
// ------------------------

model Account {
  id                String  @id @default(cuid())
  userId            String
  type              String
  provider          String
  providerAccountId String
  refresh_token     String?
  access_token      String?
  expires_at        Int?
  token_type        String?
  scope             String?
  id_token          String?
  session_state     String?

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([provider, providerAccountId])
  @@index([userId])
}

model Session {
  id           String   @id @default(cuid())
  sessionToken String   @unique
  userId       String
  expires      DateTime

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
}

model VerificationToken {
  identifier String
  token      String   @unique
  expires    DateTime

  @@unique([identifier, token])
}

// ========================
// Shop & E-commerce System
// ========================

model Brand {
  id          String   @id @default(cuid())
  name        String   @unique
  slug        String   @unique
  description String?
  logoUrl     String?
  bannerUrl   String?
  ownerId     String
  isVerified  Boolean  @default(false)
  status      String   @default("ACTIVE") // ACTIVE, SUSPENDED, INACTIVE
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  websiteUrl   String?
  competitors  Brand[] @relation("BrandCompetitors")
  competitorOf Brand[] @relation("BrandCompetitors")

  owner        User            @relation("BrandsOwned", fields: [ownerId], references: [id], onDelete: Cascade)
  products     Product[]
  reviews      BrandReview[]
  analyticsLog BrandAnalytics?

  banReason String?

  @@index([ownerId])
  @@index([status])
}

model Product {
  id              String  @id @default(cuid())
  brandId         String?
  sellerId        String?
  name            String
  slug            String
  description     String?
  price           Float
  externalUrl     String  @default("") // URL to buy the product
  discountPrice   Float?
  discountPercent Int? // 0-100
  stock           Int     @default(0)
  category        String? // CLOTHING, ELECTRONICS, ACCESSORIES, etc.

  // New fields for Digital Marketplace
  type             String   @default("PHYSICAL") // PHYSICAL, COURSE, EBOOK, DIGITAL_ASSET, TEMPLATE, HOPIN_PLAN
  digitalFileUrl   String? // For Ebooks, Assets
  linkedResourceId String? // ID of the Canvas Template or Hopin Plan
  images           String? // JSON array of image URLs
  tags             String? // JSON array of tags
  status           String   @default("ACTIVE") // ACTIVE, INACTIVE, DISCONTINUED
  isTrending       Boolean  @default(false)
  isFeatured       Boolean  @default(false)
  createdAt        DateTime @default(now())
  updatedAt        DateTime @updatedAt

  brand        Brand?            @relation(fields: [brandId], references: [id], onDelete: Cascade)
  seller       User?             @relation("ProductsSold", fields: [sellerId], references: [id], onDelete: Cascade)
  reviews      ProductReview[]
  orderItems   OrderItem[]
  reports      Report[]
  analyticsLog ProductAnalytics?
  views        ProductView[]

  @@unique([brandId, slug])
  @@index([brandId])
  @@index([sellerId])
  @@index([category])
  @@index([status])
  @@index([isTrending])
  @@index([isFeatured])
  @@index([type])
}

model ProductView {
  id        String   @id @default(cuid())
  productId String
  userId    String?
  viewedAt  DateTime @default(now())

  product Product @relation(fields: [productId], references: [id], onDelete: Cascade)
  user    User?   @relation("ProductViews", fields: [userId], references: [id], onDelete: SetNull)

  @@index([productId])
  @@index([userId])
  @@index([viewedAt])
}

model ProductReview {
  id        String   @id @default(cuid())
  productId String
  userId    String
  rating    Int // 1-5
  comment   String?
  images    String? // JSON array
  createdAt DateTime @default(now())

  product Product @relation(fields: [productId], references: [id], onDelete: Cascade)
  user    User    @relation("ProductReviews", fields: [userId], references: [id], onDelete: Cascade)

  @@unique([productId, userId])
  @@index([productId])
  @@index([userId])
}

model BrandReview {
  id        String   @id @default(cuid())
  brandId   String
  userId    String
  rating    Int // 1-5
  comment   String?
  createdAt DateTime @default(now())

  brand Brand @relation(fields: [brandId], references: [id], onDelete: Cascade)
  user  User  @relation("BrandReviews", fields: [userId], references: [id], onDelete: Cascade)

  @@unique([brandId, userId])
  @@index([brandId])
  @@index([userId])
}

model Order {
  id              String   @id @default(cuid())
  userId          String
  status          String   @default("PENDING") // PENDING, CONFIRMED, SHIPPED, DELIVERED, CANCELLED
  totalAmount     Float
  shippingAddress String?
  trackingId      String?
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  user    User          @relation("Orders", fields: [userId], references: [id], onDelete: Cascade)
  items   OrderItem[]
  returns OrderReturn[]
  reports Report[]

  @@index([userId])
  @@index([status])
}

model OrderItem {
  id        String   @id @default(cuid())
  orderId   String
  productId String
  quantity  Int
  price     Float // price at time of order
  createdAt DateTime @default(now())

  order   Order   @relation(fields: [orderId], references: [id], onDelete: Cascade)
  product Product @relation(fields: [productId], references: [id], onDelete: Restrict)

  @@index([orderId])
  @@index([productId])
}

model OrderReturn {
  id           String   @id @default(cuid())
  orderId      String
  reason       String
  status       String   @default("PENDING") // PENDING, APPROVED, REJECTED, REFUNDED
  refundAmount Float?
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  order Order @relation(fields: [orderId], references: [id], onDelete: Cascade)

  @@index([orderId])
  @@index([status])
}

model ProductAnalytics {
  id           String   @id @default(cuid())
  productId    String   @unique
  views        Int      @default(0) // Product Details View
  impressions  Int      @default(0) // Store/List View
  purchases    Int      @default(0) // Redirects (renamed concept in UI)
  revenue      Float    @default(0)
  avgRating    Float    @default(0)
  totalReviews Int      @default(0)
  lastUpdated  DateTime @updatedAt

  product Product @relation(fields: [productId], references: [id], onDelete: Cascade)

  @@index([productId])
}

model BrandAnalytics {
  id               String   @id @default(cuid())
  brandId          String   @unique
  totalViews       Int      @default(0)
  totalImpressions Int      @default(0) // New field
  totalOrders      Int      @default(0) // Redirects
  totalRevenue     Float    @default(0)
  activeUsers      Int      @default(0)
  avgRating        Float    @default(0)
  lastUpdated      DateTime @updatedAt

  brand Brand @relation(fields: [brandId], references: [id], onDelete: Cascade)

  @@index([brandId])
}

model Deal {
  id            String   @id @default(cuid())
  brandId       String? // If null, it's a platform-wide deal
  productIds    String // JSON array of product IDs
  title         String
  description   String?
  discountType  String // PERCENTAGE, FIXED_AMOUNT
  discountValue Float
  startDate     DateTime
  endDate       DateTime
  status        String   @default("ACTIVE") // ACTIVE, ENDED, SCHEDULED
  createdAt     DateTime @default(now())

  @@index([brandId])
  @@index([status])
}

// ========================
// Awe Routes - Places & Photos
// ========================

model RouteWaypoint {
  id          String   @id @default(cuid())
  userId      String
  routeId     String // OSM place ID or custom identifier
  lat         Float
  lng         Float
  name        String
  description String?
  emoji       String   @default("") // Visual marker
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  // Relations
  user   User            @relation(fields: [userId], references: [id], onDelete: Cascade)
  photos WaypointPhoto[]

  @@index([userId])
  @@index([routeId])
  @@index([createdAt])
}

model WaypointPhoto {
  id         String   @id @default(cuid())
  waypointId String
  userId     String
  url        String // URL to uploaded image
  caption    String?
  visibility String   @default("PRIVATE") // PUBLIC, FRIENDS, PRIVATE
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt

  // Relations
  waypoint RouteWaypoint @relation(fields: [waypointId], references: [id], onDelete: Cascade)
  user     User          @relation("WaypointPhotoAuthor", fields: [userId], references: [id], onDelete: Cascade)
  shares   PhotoShare[]

  @@index([waypointId])
  @@index([userId])
  @@index([visibility])
}

model PhotoShare {
  id        String   @id @default(cuid())
  photoId   String
  userId    String // User who the photo is shared with (for FRIENDS sharing)
  createdAt DateTime @default(now())

  // Relations
  photo WaypointPhoto @relation(fields: [photoId], references: [id], onDelete: Cascade)
  user  User          @relation("PhotoShareRecipient", fields: [userId], references: [id], onDelete: Cascade)

  @@unique([photoId, userId])
  @@index([photoId])
  @@index([userId])
}

model PlaceReview {
  id        String    @id @default(cuid())
  userId    String
  osmId     String // OpenStreetMap place ID
  placeName String // Cafe, Restaurant, ATM, etc.
  category  String // POI category
  lat       Float
  lng       Float
  rating    Int // 1-5 stars
  text      String? // Review text
  visited   DateTime?
  createdAt DateTime  @default(now())
  updatedAt DateTime  @updatedAt

  // Relations
  user   User         @relation(fields: [userId], references: [id], onDelete: Cascade)
  photos PlacePhoto[]

  @@index([userId])
  @@index([osmId])
  @@index([category])
  @@index([createdAt])
}

model PlacePhoto {
  id         String   @id @default(cuid())
  reviewId   String
  userId     String
  url        String // URL to uploaded image
  caption    String?
  visibility String   @default("PUBLIC") // PUBLIC, FRIENDS, PRIVATE
  createdAt  DateTime @default(now())

  // Relations
  review PlaceReview       @relation(fields: [reviewId], references: [id], onDelete: Cascade)
  user   User              @relation("PlacePhotoAuthor", fields: [userId], references: [id], onDelete: Cascade)
  shares PlacePhotoShare[]

  @@index([reviewId])
  @@index([userId])
  @@index([visibility])
}

model PlacePhotoShare {
  id        String   @id @default(cuid())
  photoId   String
  userId    String // User who the photo is shared with
  createdAt DateTime @default(now())

  // Relations
  photo PlacePhoto @relation(fields: [photoId], references: [id], onDelete: Cascade)
  user  User       @relation("PlacePhotoShareRecipient", fields: [userId], references: [id], onDelete: Cascade)

  @@unique([photoId, userId])
  @@index([photoId])
  @@index([userId])
}

// ========================
// Razorpay Payment System
// ========================

model Payment {
  id            String  @id @default(cuid())
  userId        String
  orderId       String // Razorpay order ID
  paymentId     String? // Razorpay payment ID (set after successful payment)
  amount        Float // Amount in rupees
  currency      String  @default("INR")
  // Status: CREATED | AUTHORIZED | CAPTURED | FAILED | REFUNDED
  status        String  @default("CREATED")
  // Payment method: card, netbanking, wallet, upi, etc.
  paymentMethod String?
  // Description of the payment
  description   String?
  // Razorpay receipt ID
  receiptId     String?
  // Failure reason if payment failed
  failureReason String?
  // Refund details (JSON)
  refundData    String?
  // Signature verification
  signatureId   String?
  signatureData String?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  user        User         @relation(fields: [userId], references: [id], onDelete: Cascade)
  webhookLogs WebhookLog[]

  @@unique([orderId])
  @@index([userId])
  @@index([status])
  @@index([paymentId])
  @@index([createdAt])
}

// ========================
// Bonding & Collaboration
// ========================

model BondingActivity {
  id        String    @id @default(cuid())
  userId    String
  partnerId String?
  type      String // CANVAS, JOURNAL, HOPIN, etc.
  status    String    @default("STARTED") // STARTED, COMPLETED
  startedAt DateTime  @default(now())
  endedAt   DateTime?
  details   String? // JSON for extra metadata

  user User @relation("BondingActivities", fields: [userId], references: [id], onDelete: Cascade)
  // Optional relation to partner if needed for queries, though explicit relation field on User might be heavy if many activities.
  // Keeping it lightweight for now.

  @@index([userId])
  @@index([type])
}

model WebhookLog {
  id              String    @id @default(cuid())
  paymentId       String? // Reference to Payment record
  razorpayEventId String // Razorpay webhook event ID for idempotency
  eventType       String // payment.authorized | payment.captured | payment.failed | refund.created
  // Request payload (stored as JSON string)
  payload         String
  // Signature verification result
  signatureValid  Boolean   @default(false)
  // Processing status: PENDING | PROCESSED | FAILED
  status          String    @default("PENDING")
  // Error message if processing failed
  errorMessage    String?
  // Number of retry attempts
  retryCount      Int       @default(0)
  // Next retry timestamp
  nextRetryAt     DateTime?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  payment Payment? @relation(fields: [paymentId], references: [id], onDelete: SetNull)

  @@unique([razorpayEventId]) // Ensures idempotency
  @@index([paymentId])
  @@index([eventType])
  @@index([status])
  @@index([createdAt])
}

// ------------------------
// AI Chatbot / Podcaster ("dbot")
// ------------------------

model UserInsight {
  id         String   @id @default(cuid())
  userId     String
  // e.g. "User feels anxious about work", "User likes nature metaphors"
  content    String
  // Confidence score (0.0 - 1.0)
  confidence Float    @default(1.0)
  createdAt  DateTime @default(now())

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
}

model AIChatSession {
  id        String   @id @default(cuid())
  userId    String
  title     String?
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  user     User            @relation(fields: [userId], references: [id], onDelete: Cascade)
  messages AIChatMessage[]

  @@index([userId])
  @@index([updatedAt])
}

model AIChatMessage {
  id        String   @id @default(cuid())
  sessionId String
  role      String // "user" | "assistant" | "system"
  content   String
  createdAt DateTime @default(now())

  session AIChatSession @relation(fields: [sessionId], references: [id], onDelete: Cascade)

  @@index([sessionId])
  @@index([createdAt])
}

// ------------------------
// Profile Cards
// ------------------------

model ProfileCard {
  id         String   @id @default(cuid())
  userId     String   @unique
  uniqueCode String   @unique // 7-digit alphanumeric code
  content    String // JSON: stores sections, questions, and answers
  theme      String? // e.g. "dark", "glass", "sunset"
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([uniqueCode])
}

// ------------------------
// Content Moderation Logs
// ------------------------
model ModerationLog {
  id         String   @id @default(cuid())
  userId     String
  content    String
  reason     String // "BLOCK" | "FLAG"
  violations String // JSON string of arrays
  severity   String // "none" | "low" | "medium" | "high"
  createdAt  DateTime @default(now())

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([createdAt])
}

model ViewHistory {
  id       String   @id @default(cuid())
  userId   String
  postId   String
  viewedAt DateTime @default(now())

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)
  post Post @relation(fields: [postId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([viewedAt])
}

model PostTag {
  id        String   @id @default(cuid())
  postId    String
  userId    String // The user being tagged
  createdAt DateTime @default(now())

  post Post @relation(fields: [postId], references: [id], onDelete: Cascade)
  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([postId, userId])
  @@index([userId])
}

model BiometricLog {
  id          String   @id @default(cuid())
  userId      String
  date        DateTime @default(now())
  weight      Float?
  heartRate   Int?
  sleepHours  Float?
  hydration   Int?     // ml
  mood        String?  // 'great' | 'good' | 'meh' | 'bad' | 'terrible'
  createdAt   DateTime @default(now())

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)


  @@index([userId])
  @@index([date])
}

model NutritionLog {
  id        String   @id @default(cuid())
  userId    String
  date      DateTime @default(now())
  calories  Int      @default(0)
  protein   Int      @default(0)
  carbs     Int      @default(0)
  fats      Int      @default(0)
  meals     Json?
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  @@index([userId])
  @@index([date])
}

model SavedFood {
  id        String   @id @default(cuid())
  userId    String
  name      String
  calories  Int
  protein   Int
  carbs     Int
  fats      Int
  createdAt DateTime @default(now())
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  @@index([userId])
}
