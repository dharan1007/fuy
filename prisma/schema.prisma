// prisma/schema.prisma

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// NOTE: We keep string-based "enums" (status/role/type fields) for portability.
// Validate allowed values in application code.
// For structured data (blocks, tags, sensations, meta) we store JSON strings
// in TEXT-like columns (String in Prisma).

// ------------------------
// Core User & Social Graph
// ------------------------

model User {
  id        String   @id @default(cuid())
  email     String   @unique
  password  String?  // hashed password for email/password auth
  name      String?
  emailVerified DateTime?
  createdAt DateTime @default(now())
  // Follower/Following counts for real-time updates
  followersCount  Int @default(0)
  followingCount  Int @default(0)

  // Relations
  profile         Profile?
  posts           Post[]
  media           Media[]
  groupsOwned     Group[]             @relation("GroupsOwned")
  groupMembers    GroupMember[]
  friendshipsA    Friendship[]        @relation("A")
  friendshipsB    Friendship[]        @relation("B")
  happiness       HappinessScore[]
  userValues      UserValue[]
  bonds           BondBlueprint[]
  drills          ConflictDrill[]
  passkeys        PasskeyCredential[]
  serendipityLogs SerendipityLog[]

  // New: metrics back-relation
  metrics Metric[]

  // New: journaling & templates
  journalEntries   JournalEntry[]
  journalTemplates JournalTemplate[]

  // Invites back-relation
  invitesSent Invite[]

  // --- Work management back-relations (added) ---
  orgsOwned       Organization[]        @relation("OrgOwner")
  orgMembership   OrgMember[]
  tasksCreated    Task[]                @relation("TaskCreator")
  taskAssignee    TaskAssignee[]
  checklistChecks TaskChecklistItem[]   @relation("ChecklistCheckedBy")
  taskComments    TaskComment[]         @relation("TaskCommentAuthor")
  taskVolunteers  TaskVolunteer[]
  reminders       Reminder[]

  // --- Auth.js / NextAuth back-relations ---
  accounts     Account[]
  sessions     Session[]
  postLikes    PostLike[]
  postComments PostComment[]

  // --- Chat & Messaging ---
  conversationsA    Conversation[]        @relation("ConversationA")
  conversationsB    Conversation[]        @relation("ConversationB")
  messagesSent      Message[]             @relation("MessagesSent")
  chatSessions      ChatSessionLog[]      @relation("ChatSessions")
  chatAnalytics     ChatAnalytics?        @relation("Analytics")
  featureSessions   FeatureSession[]      @relation("FeatureSessions")
  featureParticipant FeatureSessionParticipant[] @relation("FeatureParticipants")

  // --- Collaboration Features ---
  collaborationInvitesSent CollaborationInvite[] @relation("CollaborationInvitesSent")
  collaborationInvitesReceived CollaborationInvite[] @relation("CollaborationInvitesReceived")
  collaborationUpdates CollaborationUpdate[]

  // --- Shop & E-commerce ---
  brandsOwned     Brand[]              @relation("BrandsOwned")
  productReviews  ProductReview[]      @relation("ProductReviews")
  brandReviews    BrandReview[]        @relation("BrandReviews")
  orders          Order[]              @relation("Orders")
  payments        Payment[]            // Razorpay payments

  // --- Awe Routes & Places ---
  waypoints       RouteWaypoint[]
  waypointPhotos  WaypointPhoto[]      @relation("WaypointPhotoAuthor")
  photoShares     PhotoShare[]         @relation("PhotoShareRecipient")
  placeReviews    PlaceReview[]
  placePhotos     PlacePhoto[]         @relation("PlacePhotoAuthor")
  placePhotoShares PlacePhotoShare[]   @relation("PlacePhotoShareRecipient")
}

model Profile {
  userId        String  @id
  displayName   String?
  avatarUrl     String?
  bio           String?
  location      String?
  tags          String?
  coverVideoUrl String?      // <â€” NEW

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)
}

model Group {
  id          String   @id @default(cuid())
  name        String
  description String?
  ownerId     String
  createdAt   DateTime @default(now())

  owner   User          @relation("GroupsOwned", fields: [ownerId], references: [id], onDelete: Cascade)
  members GroupMember[]
  posts   Post[]
}

model GroupMember {
  id        String   @id @default(cuid())
  userId    String
  groupId   String
  // Allowed: OWNER | ADMIN | MEMBER
  role      String   @default("MEMBER")
  createdAt DateTime @default(now())

  user  User  @relation(fields: [userId], references: [id], onDelete: Cascade)
  group Group @relation(fields: [groupId], references: [id], onDelete: Cascade)

  @@unique([userId, groupId])
}

model Friendship {
  id        String   @id @default(cuid())
  userId    String
  friendId  String
  // Allowed: PENDING | ACCEPTED | BLOCKED | GHOSTED
  status    String   @default("PENDING")
  // Track if request was ghosted by the recipient
  isGhosted Boolean  @default(false)
  // ID of user who ghosted (the recipient if ghosted)
  ghostedBy String?
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  user   User @relation("A", fields: [userId], references: [id], onDelete: Cascade)
  friend User @relation("B", fields: [friendId], references: [id], onDelete: Cascade)

  @@unique([userId, friendId])
}

model Post {
  id              String   @id @default(cuid())
  userId          String
  groupId         String?
  // Allowed: JOURNAL | JOY | AWE | BONDS | SERENDIPITY | CHECKIN | PROGRESS | OTHER
  feature         String   @default("OTHER")
  content         String
  // Allowed: PUBLIC | FRIENDS | PRIVATE
  visibility      String   @default("PUBLIC")
  joyScore        Int      @default(0)
  connectionScore Int      @default(0)
  creativityScore Int      @default(0)
  createdAt       DateTime @default(now())

  user     User          @relation(fields: [userId], references: [id], onDelete: Cascade)
  group    Group?        @relation(fields: [groupId], references: [id], onDelete: SetNull)
  media    Media[]
  likes    PostLike[]
  comments PostComment[]
  shares   PostShare[]
}

model PostLike {
  id        String   @id @default(cuid())
  userId    String
  postId    String
  createdAt DateTime @default(now())

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)
  post Post @relation(fields: [postId], references: [id], onDelete: Cascade)

  @@unique([userId, postId])
  @@index([postId])
  @@index([userId])
}

model PostComment {
  id        String   @id @default(cuid())
  userId    String
  postId    String
  content   String
  createdAt DateTime @default(now())

  post Post @relation(fields: [postId], references: [id], onDelete: Cascade)
  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([postId])
  @@index([userId])
}

model PostShare {
  id        String   @id @default(cuid())
  userId    String
  postId    String
  toUserId  String?
  toGroupId String?
  message   String?
  createdAt DateTime @default(now())

  post Post @relation(fields: [postId], references: [id], onDelete: Cascade)

  @@index([postId])
  @@index([userId])
  @@index([toUserId])
  @@index([toGroupId])
}

model Notification {
  id        String   @id @default(cuid())
  userId    String
  type      String
  message   String
  postId    String?
  read      Boolean  @default(false)
  createdAt DateTime @default(now())

  @@index([userId, read])
  @@index([createdAt])
}

model Media {
  id        String   @id @default(cuid())
  postId    String
  userId    String
  // Mirrors post feature: JOURNAL | JOY | ...
  feature   String   @default("OTHER")
  // Allowed: IMAGE | VIDEO | AUDIO
  type      String
  url       String
  createdAt DateTime @default(now())

  post Post @relation(fields: [postId], references: [id], onDelete: Cascade)
  user User @relation(fields: [userId], references: [id], onDelete: Cascade)
}

model HappinessScore {
  id        String   @id @default(cuid())
  userId    String
  // Allowed: JOY | CONNECTION | CREATIVITY
  category  String
  value     Int
  // Source feature: JOURNAL | JOY | AWE | BONDS | SERENDIPITY | CHECKIN | PROGRESS | OTHER
  source    String   @default("OTHER")
  createdAt DateTime @default(now())

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)
}

model Value {
  id    String @id @default(cuid())
  slug  String @unique
  label String

  userValues UserValue[]
}

model UserValue {
  id      String @id @default(cuid())
  userId  String
  valueId String
  rank    Int

  user  User  @relation(fields: [userId], references: [id], onDelete: Cascade)
  value Value @relation(fields: [valueId], references: [id], onDelete: Cascade)

  @@unique([userId, valueId])
}

model BondBlueprint {
  id         String   @id @default(cuid())
  userId     String
  personName String
  goal       String?
  notes      String?
  createdAt  DateTime @default(now())

  user   User            @relation(fields: [userId], references: [id], onDelete: Cascade)
  drills ConflictDrill[]
}

model ConflictDrill {
  id          String    @id @default(cuid())
  userId      String
  blueprintId String?
  notes       String?
  resolvedAt  DateTime?
  createdAt   DateTime  @default(now())

  user      User           @relation(fields: [userId], references: [id], onDelete: Cascade)
  blueprint BondBlueprint? @relation(fields: [blueprintId], references: [id], onDelete: SetNull)
}

model PasskeyCredential {
  id                  String  @id @default(cuid())
  userId              String
  credentialID        String  @unique // base64url
  credentialPublicKey String  // base64url
  counter             Int     @default(0)
  transports          String? // comma-separated list
  aaguid              String? // optional

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
}

model SerendipityLog {
  id        String   @id @default(cuid())
  userId    String
  weekNum   Int
  year      Int
  packId    String?
  completed Boolean  @default(false)
  notes     String?
  createdAt DateTime @default(now())

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId, weekNum, year])
}

// New: Generic metrics table for stats from any feature (e.g., stress_avg_intensity, calm_index).
// Stores a numeric value plus optional category. User is optional to allow anonymous.
model Metric {
  id        String   @id @default(cuid())
  userId    String?
  type      String
  category  String?
  value     Float
  createdAt DateTime @default(now())

  user User? @relation(fields: [userId], references: [id], onDelete: SetNull)

  @@index([type, createdAt])
  @@index([userId, type, createdAt])
}

// ------------------------
// Journaling (Canvas + Templates)
// ------------------------

model JournalEntry {
  id               String    @id @default(cuid())
  userId           String
  content          String
  blocks           String? // JSON string: [{ id, type: "TEXT" | "IMAGE" | "VIDEO" | "AUDIO", ... }]
  // Optional extras used by your UI (all optional to keep flexible)
  mood             Int?
  moodColor        String?
  tags             String? // JSON string: ["gratitude","walk"]
  sensations       String? // JSON string: [{ zone: "Chest", note: "tight" }]
  meta             String? // JSON string: template blocks used, persona, etc.
  unlockAt         DateTime?
  shadowPassphrase String? // store hashed in API if sensitive
  visibility       String    @default("PRIVATE") // if you ever expose journals themselves

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId, createdAt])
  @@index([visibility, createdAt])
}

// Reusable canvas templates users can publish or keep private.
// Blocks are stored as JSON string in TEXT; owner is required.
model JournalTemplate {
  id          String  @id @default(cuid())
  userId      String
  name        String
  description String?
  visibility  String  @default("PRIVATE") // PUBLIC | PRIVATE
  blocks      String // JSON string
  author      String?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId, createdAt])
  @@index([visibility, createdAt])
}

// ------------------------
// Invites (added)
// ------------------------

model Invite {
  id         String    @id @default(cuid())
  token      String    @unique
  email      String?
  username   String?
  inviterId  String
  status     String    @default("PENDING") // PENDING | ACCEPTED | REVOKED | EXPIRED
  createdAt  DateTime  @default(now())
  expiresAt  DateTime
  acceptedAt DateTime?
  revokedAt  DateTime?

  inviter User @relation(fields: [inviterId], references: [id], onDelete: Cascade)

  @@index([inviterId])
  @@index([status, expiresAt])
}

// ------------------------
// Work Management (Organizations / Projects / Tasks)
// ------------------------

model Organization {
  id          String       @id @default(cuid())
  name        String
  description String?
  ownerId     String
  createdAt   DateTime     @default(now())
  updatedAt   DateTime     @updatedAt

  owner       User         @relation("OrgOwner", fields: [ownerId], references: [id], onDelete: Cascade)
  members     OrgMember[]
  projects    Project[]
  tags        Tag[]
}

model OrgMember {
  id              String        @id @default(cuid())
  organizationId  String
  userId          String
  role            String        @default("MEMBER") // ADMIN | MANAGER | MEMBER
  createdAt       DateTime      @default(now())

  organization    Organization  @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  user            User          @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([organizationId, userId])
  @@index([organizationId])
  @@index([userId])
}

model Project {
  id              String        @id @default(cuid())
  organizationId  String
  name            String
  description     String?
  status          String        @default("ACTIVE") // ACTIVE | ARCHIVED
  startDate       DateTime?
  dueDate         DateTime?
  createdAt       DateTime      @default(now())
  updatedAt       DateTime      @updatedAt

  organization    Organization  @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  tasks           Task[]

  @@index([organizationId])
  @@index([status])
  @@index([dueDate])
}

model Task {
  id              String        @id @default(cuid())
  projectId       String
  title           String
  description     String?
  status          String        @default("TODO")   // TODO | IN_PROGRESS | REVIEW | DONE
  priority        String        @default("MEDIUM") // LOW | MEDIUM | HIGH | URGENT
  startDate       DateTime?
  dueDate         DateTime?
  createdById     String
  timeEstimateMin Int?
  createdAt       DateTime      @default(now())
  updatedAt       DateTime      @updatedAt

  project         Project       @relation(fields: [projectId], references: [id], onDelete: Cascade)
  createdBy       User          @relation("TaskCreator", fields: [createdById], references: [id], onDelete: Cascade)

  assignees       TaskAssignee[]
  checklist       TaskChecklistItem[]
  comments        TaskComment[]
  tags            TaskTag[]
  reminders       Reminder[]
  volunteers      TaskVolunteer[]

  @@index([projectId])
  @@index([status])
  @@index([dueDate])
}

model TaskAssignee {
  id         String @id @default(cuid())
  taskId     String
  userId     String
  assignedAt DateTime @default(now())

  task       Task   @relation(fields: [taskId], references: [id], onDelete: Cascade)
  user       User   @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([taskId, userId])
  @@index([userId])
}

model TaskChecklistItem {
  id          String   @id @default(cuid())
  taskId      String
  label       String
  completed   Boolean  @default(false)
  checkedById String?
  checkedAt   DateTime?

  task        Task     @relation(fields: [taskId], references: [id], onDelete: Cascade)
  checkedBy   User?    @relation("ChecklistCheckedBy", fields: [checkedById], references: [id], onDelete: SetNull)

  @@index([taskId])
  @@index([checkedById])
}

model TaskComment {
  id        String   @id @default(cuid())
  taskId    String
  authorId  String
  body      String
  createdAt DateTime @default(now())

  task      Task     @relation(fields: [taskId], references: [id], onDelete: Cascade)
  author    User     @relation("TaskCommentAuthor", fields: [authorId], references: [id], onDelete: Cascade)

  @@index([taskId])
  @@index([authorId])
}

model Tag {
  id             String         @id @default(cuid())
  organizationId String
  name           String
  colorHex       String?
  createdAt      DateTime       @default(now())

  organization   Organization   @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  taskTags       TaskTag[]

  @@unique([organizationId, name])
  @@index([organizationId])
}

model TaskTag {
  id     String @id @default(cuid())
  taskId String
  tagId  String

  task   Task   @relation(fields: [taskId], references: [id], onDelete: Cascade)
  tag    Tag    @relation(fields: [tagId], references: [id], onDelete: Cascade)

  @@unique([taskId, tagId])
  @@index([tagId])
}

model TaskVolunteer {
  id        String   @id @default(cuid())
  taskId    String
  userId    String
  status    String   @default("REQUESTED") // REQUESTED | APPROVED | DECLINED
  createdAt DateTime @default(now())

  task      Task     @relation(fields: [taskId], references: [id], onDelete: Cascade)
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([taskId, userId])
  @@index([userId])
}

model Reminder {
  id         String   @id @default(cuid())
  taskId     String
  userId     String
  triggerAt  DateTime
  type       String   @default("DUE") // DUE | START | CUSTOM
  sent       Boolean  @default(false)
  createdAt  DateTime @default(now())

  task       Task     @relation(fields: [taskId], references: [id], onDelete: Cascade)
  user       User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([triggerAt, sent])
  @@index([userId])
}

// ------------------------
// Chat & Messaging System
// ------------------------

model Conversation {
  id            String   @id @default(cuid())
  participantA  String   // userId of participant A
  participantB  String   // userId of participant B
  lastMessage   String?
  lastMessageAt DateTime?
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  userA         User     @relation("ConversationA", fields: [participantA], references: [id], onDelete: Cascade)
  userB         User     @relation("ConversationB", fields: [participantB], references: [id], onDelete: Cascade)
  messages      Message[]
  sessionLogs   ChatSessionLog[]
  collaborationInvites CollaborationInvite[]

  @@unique([participantA, participantB])
  @@index([participantA])
  @@index([participantB])
  @@index([lastMessageAt])
}

model Message {
  id              String   @id @default(cuid())
  conversationId  String
  senderId        String
  content         String
  readAt          DateTime?
  createdAt       DateTime @default(now())

  conversation    Conversation @relation(fields: [conversationId], references: [id], onDelete: Cascade)
  sender          User         @relation("MessagesSent", fields: [senderId], references: [id], onDelete: Cascade)

  @@index([conversationId])
  @@index([senderId])
  @@index([createdAt])
}

model ChatSessionLog {
  id              String   @id @default(cuid())
  conversationId  String
  userId          String
  startTime       DateTime @default(now())
  endTime         DateTime?
  durationMinutes Int?     // Calculated duration

  conversation    Conversation @relation(fields: [conversationId], references: [id], onDelete: Cascade)
  user            User         @relation("ChatSessions", fields: [userId], references: [id], onDelete: Cascade)

  @@index([conversationId])
  @@index([userId])
  @@index([startTime])
}

model ChatAnalytics {
  id                String   @id @default(cuid())
  userId            String
  totalMessagesCount Int     @default(0)
  totalChatTimeMinutes Int   @default(0)
  mostFrequentContactId String?
  lastAnalyzedAt    DateTime @default(now())
  updatedAt         DateTime @updatedAt

  user              User     @relation("Analytics", fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId])
  @@index([userId])
}

// Feature Collaboration: Track collaborative sessions
model FeatureSession {
  id             String   @id @default(cuid())
  type           String   // "JOURNALING" | "HOPPING" | "BONDING" | "BREATHING"
  creatorId      String
  conversationId String?  // Link to chat for planning
  title          String?
  description    String?
  status         String   @default("ACTIVE") // ACTIVE | ARCHIVED
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt

  // Collaboration features
  canvasData     String?  // JSON: blocks, drawing state
  autoSaveEnabled Boolean @default(true)
  lastSavedAt    DateTime?
  lastModifiedBy String?
  syncVersion    Int      @default(0)

  creator        User     @relation("FeatureSessions", fields: [creatorId], references: [id], onDelete: Cascade)
  participants   FeatureSessionParticipant[]
  invites        CollaborationInvite[]
  updates        CollaborationUpdate[]

  @@index([creatorId])
  @@index([type])
  @@index([status])
  @@index([lastModifiedBy])
  @@index([updatedAt])
}

model FeatureSessionParticipant {
  id             String   @id @default(cuid())
  sessionId      String
  userId         String
  joinedAt       DateTime @default(now())
  status         String   @default("ACTIVE") // ACTIVE | LEFT | INVITED

  session        FeatureSession @relation(fields: [sessionId], references: [id], onDelete: Cascade)
  user           User           @relation("FeatureParticipants", fields: [userId], references: [id], onDelete: Cascade)

  @@unique([sessionId, userId])
  @@index([sessionId])
  @@index([userId])
}

// Collaboration Invites - for messaging system
model CollaborationInvite {
  id               String   @id @default(cuid())
  sessionId        String
  fromUserId       String
  toUserId         String
  featureType      String   // CANVAS | HOPIN | BREATHING | etc.
  status           String   @default("PENDING") // PENDING | ACCEPTED | REJECTED | CANCELLED
  messageId        String?
  conversationId   String
  createdAt        DateTime @default(now())
  respondedAt      DateTime?

  session          FeatureSession @relation(fields: [sessionId], references: [id], onDelete: Cascade)
  fromUser         User     @relation("CollaborationInvitesSent", fields: [fromUserId], references: [id], onDelete: Cascade)
  toUser           User     @relation("CollaborationInvitesReceived", fields: [toUserId], references: [id], onDelete: Cascade)
  conversation     Conversation @relation(fields: [conversationId], references: [id], onDelete: Cascade)

  @@unique([sessionId, fromUserId, toUserId])
  @@index([sessionId])
  @@index([fromUserId])
  @@index([toUserId])
  @@index([conversationId])
  @@index([status])
  @@index([createdAt])
}

// Collaboration Updates - for tracking changes in real-time
model CollaborationUpdate {
  id         String   @id @default(cuid())
  sessionId  String
  userId     String
  operation  String   // ADD_BLOCK | UPDATE_BLOCK | REMOVE_BLOCK | DRAW | SAVE
  blockId    String?
  data       String   // JSON: the actual change data
  timestamp  DateTime @default(now())
  synced     Boolean  @default(false)

  session    FeatureSession @relation(fields: [sessionId], references: [id], onDelete: Cascade)
  user       User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([sessionId])
  @@index([userId])
  @@index([timestamp])
  @@index([synced])
  @@index([sessionId, timestamp])
}

// ------------------------
// Auth.js / NextAuth tables
// ------------------------

model Account {
  id                String  @id @default(cuid())
  userId            String
  type              String
  provider          String
  providerAccountId String
  refresh_token     String?
  access_token      String?
  expires_at        Int?
  token_type        String?
  scope             String?
  id_token          String?
  session_state     String?

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([provider, providerAccountId])
  @@index([userId])
}

model Session {
  id           String   @id @default(cuid())
  sessionToken String   @unique
  userId       String
  expires      DateTime

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
}

model VerificationToken {
  identifier String
  token      String   @unique
  expires    DateTime

  @@unique([identifier, token])
}

// ========================
// Shop & E-commerce System
// ========================

model Brand {
  id            String   @id @default(cuid())
  name          String   @unique
  slug          String   @unique
  description   String?
  logoUrl       String?
  bannerUrl     String?
  ownerId       String
  isVerified    Boolean  @default(false)
  status        String   @default("ACTIVE") // ACTIVE, SUSPENDED, INACTIVE
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  owner        User           @relation("BrandsOwned", fields: [ownerId], references: [id], onDelete: Cascade)
  products     Product[]
  reviews      BrandReview[]
  analyticsLog BrandAnalytics?

  @@index([ownerId])
  @@index([status])
}

model Product {
  id            String   @id @default(cuid())
  brandId       String
  name          String
  slug          String
  description   String?
  price         Float
  discountPrice Float?
  discountPercent Int?    // 0-100
  stock         Int      @default(0)
  category      String?  // CLOTHING, ELECTRONICS, ACCESSORIES, etc.
  images        String?  // JSON array of image URLs
  tags          String?  // JSON array of tags
  status        String   @default("ACTIVE") // ACTIVE, INACTIVE, DISCONTINUED
  isTrending    Boolean  @default(false)
  isFeatured    Boolean  @default(false)
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  brand        Brand          @relation(fields: [brandId], references: [id], onDelete: Cascade)
  reviews      ProductReview[]
  orderItems   OrderItem[]
  analyticsLog ProductAnalytics?

  @@unique([brandId, slug])
  @@index([brandId])
  @@index([category])
  @@index([status])
  @@index([isTrending])
  @@index([isFeatured])
}

model ProductReview {
  id        String   @id @default(cuid())
  productId String
  userId    String
  rating    Int      // 1-5
  comment   String?
  images    String?  // JSON array
  createdAt DateTime @default(now())

  product Product @relation(fields: [productId], references: [id], onDelete: Cascade)
  user    User    @relation("ProductReviews", fields: [userId], references: [id], onDelete: Cascade)

  @@unique([productId, userId])
  @@index([productId])
  @@index([userId])
}

model BrandReview {
  id        String   @id @default(cuid())
  brandId   String
  userId    String
  rating    Int      // 1-5
  comment   String?
  createdAt DateTime @default(now())

  brand Brand @relation(fields: [brandId], references: [id], onDelete: Cascade)
  user  User  @relation("BrandReviews", fields: [userId], references: [id], onDelete: Cascade)

  @@unique([brandId, userId])
  @@index([brandId])
  @@index([userId])
}

model Order {
  id              String   @id @default(cuid())
  userId          String
  status          String   @default("PENDING") // PENDING, CONFIRMED, SHIPPED, DELIVERED, CANCELLED
  totalAmount     Float
  shippingAddress String?
  trackingId      String?
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  user      User         @relation("Orders", fields: [userId], references: [id], onDelete: Cascade)
  items     OrderItem[]
  returns   OrderReturn[]

  @@index([userId])
  @@index([status])
}

model OrderItem {
  id        String   @id @default(cuid())
  orderId   String
  productId String
  quantity  Int
  price     Float    // price at time of order
  createdAt DateTime @default(now())

  order   Order   @relation(fields: [orderId], references: [id], onDelete: Cascade)
  product Product @relation(fields: [productId], references: [id], onDelete: Restrict)

  @@index([orderId])
  @@index([productId])
}

model OrderReturn {
  id        String   @id @default(cuid())
  orderId   String
  reason    String
  status    String   @default("PENDING") // PENDING, APPROVED, REJECTED, REFUNDED
  refundAmount Float?
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  order Order @relation(fields: [orderId], references: [id], onDelete: Cascade)

  @@index([orderId])
  @@index([status])
}

model ProductAnalytics {
  id             String   @id @default(cuid())
  productId      String   @unique
  views          Int      @default(0)
  purchases      Int      @default(0)
  revenue        Float    @default(0)
  avgRating      Float    @default(0)
  totalReviews   Int      @default(0)
  lastUpdated    DateTime @updatedAt

  product Product @relation(fields: [productId], references: [id], onDelete: Cascade)

  @@index([productId])
}

model BrandAnalytics {
  id             String   @id @default(cuid())
  brandId        String   @unique
  totalViews     Int      @default(0)
  totalOrders    Int      @default(0)
  totalRevenue   Float    @default(0)
  activeUsers    Int      @default(0)
  avgRating      Float    @default(0)
  lastUpdated    DateTime @updatedAt

  brand Brand @relation(fields: [brandId], references: [id], onDelete: Cascade)

  @@index([brandId])
}

model Deal {
  id            String   @id @default(cuid())
  brandId       String?  // If null, it's a platform-wide deal
  productIds    String   // JSON array of product IDs
  title         String
  description   String?
  discountType  String   // PERCENTAGE, FIXED_AMOUNT
  discountValue Float
  startDate     DateTime
  endDate       DateTime
  status        String   @default("ACTIVE") // ACTIVE, ENDED, SCHEDULED
  createdAt     DateTime @default(now())

  @@index([brandId])
  @@index([status])
}

// ========================
// Awe Routes - Places & Photos
// ========================

model RouteWaypoint {
  id          String   @id @default(cuid())
  userId      String
  routeId     String   // OSM place ID or custom identifier
  lat         Float
  lng         Float
  name        String
  description String?
  emoji       String   @default("ðŸ“") // Visual marker
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  // Relations
  user        User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  photos      WaypointPhoto[]

  @@index([userId])
  @@index([routeId])
  @@index([createdAt])
}

model WaypointPhoto {
  id          String   @id @default(cuid())
  waypointId  String
  userId      String
  url         String   // URL to uploaded image
  caption     String?
  visibility  String   @default("PRIVATE") // PUBLIC, FRIENDS, PRIVATE
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  // Relations
  waypoint    RouteWaypoint @relation(fields: [waypointId], references: [id], onDelete: Cascade)
  user        User          @relation("WaypointPhotoAuthor", fields: [userId], references: [id], onDelete: Cascade)
  shares      PhotoShare[]

  @@index([waypointId])
  @@index([userId])
  @@index([visibility])
}

model PhotoShare {
  id          String   @id @default(cuid())
  photoId     String
  userId      String   // User who the photo is shared with (for FRIENDS sharing)
  createdAt   DateTime @default(now())

  // Relations
  photo       WaypointPhoto @relation(fields: [photoId], references: [id], onDelete: Cascade)
  user        User          @relation("PhotoShareRecipient", fields: [userId], references: [id], onDelete: Cascade)

  @@unique([photoId, userId])
  @@index([photoId])
  @@index([userId])
}

model PlaceReview {
  id          String   @id @default(cuid())
  userId      String
  osmId       String   // OpenStreetMap place ID
  placeName   String   // Cafe, Restaurant, ATM, etc.
  category    String   // POI category
  lat         Float
  lng         Float
  rating      Int      // 1-5 stars
  text        String?  // Review text
  visited     DateTime?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  // Relations
  user        User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  photos      PlacePhoto[]

  @@index([userId])
  @@index([osmId])
  @@index([category])
  @@index([createdAt])
}

model PlacePhoto {
  id          String   @id @default(cuid())
  reviewId    String
  userId      String
  url         String   // URL to uploaded image
  caption     String?
  visibility  String   @default("PUBLIC") // PUBLIC, FRIENDS, PRIVATE
  createdAt   DateTime @default(now())

  // Relations
  review      PlaceReview @relation(fields: [reviewId], references: [id], onDelete: Cascade)
  user        User        @relation("PlacePhotoAuthor", fields: [userId], references: [id], onDelete: Cascade)
  shares      PlacePhotoShare[]

  @@index([reviewId])
  @@index([userId])
  @@index([visibility])
}

model PlacePhotoShare {
  id          String   @id @default(cuid())
  photoId     String
  userId      String   // User who the photo is shared with
  createdAt   DateTime @default(now())

  // Relations
  photo       PlacePhoto @relation(fields: [photoId], references: [id], onDelete: Cascade)
  user        User       @relation("PlacePhotoShareRecipient", fields: [userId], references: [id], onDelete: Cascade)

  @@unique([photoId, userId])
  @@index([photoId])
  @@index([userId])
}

// ========================
// Razorpay Payment System
// ========================

model Payment {
  id                String   @id @default(cuid())
  userId            String
  orderId           String   // Razorpay order ID
  paymentId         String?  // Razorpay payment ID (set after successful payment)
  amount            Float    // Amount in rupees
  currency          String   @default("INR")
  // Status: CREATED | AUTHORIZED | CAPTURED | FAILED | REFUNDED
  status            String   @default("CREATED")
  // Payment method: card, netbanking, wallet, upi, etc.
  paymentMethod     String?
  // Description of the payment
  description       String?
  // Razorpay receipt ID
  receiptId         String?
  // Failure reason if payment failed
  failureReason     String?
  // Refund details (JSON)
  refundData        String?
  // Signature verification
  signatureId       String?
  signatureData     String?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)
  webhookLogs WebhookLog[]

  @@unique([orderId])
  @@index([userId])
  @@index([status])
  @@index([paymentId])
  @@index([createdAt])
}

model WebhookLog {
  id              String   @id @default(cuid())
  paymentId       String?  // Reference to Payment record
  razorpayEventId String   // Razorpay webhook event ID for idempotency
  eventType       String   // payment.authorized | payment.captured | payment.failed | refund.created
  // Request payload (stored as JSON string)
  payload         String
  // Signature verification result
  signatureValid  Boolean  @default(false)
  // Processing status: PENDING | PROCESSED | FAILED
  status          String   @default("PENDING")
  // Error message if processing failed
  errorMessage    String?
  // Number of retry attempts
  retryCount      Int      @default(0)
  // Next retry timestamp
  nextRetryAt     DateTime?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  payment Payment? @relation(fields: [paymentId], references: [id], onDelete: SetNull)

  @@unique([razorpayEventId]) // Ensures idempotency
  @@index([paymentId])
  @@index([eventType])
  @@index([status])
  @@index([createdAt])
}
